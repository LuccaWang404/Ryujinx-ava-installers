on:
  schedule:
    - cron: '*/10 * * * *' #check update per 10 minutes

jobs:
  check-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check update & Download release
        id: check
        run: |
          $response = Invoke-RestMethod -Uri "https://api.github.com/repos/Ryujinx/release-channel-master/releases/latest"
          $tag_name = $response.tag_name
          git clone https://github.com/LuccaWang404/ryujinx-latest-tag.git
          cd ryujinx-latest-tag
          $previous_tag_name = cat ryujinx_latest_tag.txt
          if ($tag_name -eq $previous_tag_name) {
            echo No newer version has been found.
            exit 1
          }         
          else {
            echo $tag_name > ryujinx_latest_tag.txt
            git config --global user.name 'LuccaWang404'
            git config --global user.email 'jh327063592@163.com'
            git remote add origin https://${{ secrets.GITHUB_TOKEN }}@github.com/LuccaWang404/ryujinx-latest-tag.git
            git add ryujinx_latest_tag.txt
            git commit -m "Version Update"
            git push origin main
          }
          cd ..
          wget -o test-ava-ryujinx-$tag_name-win_x64.zip https://github.com/Ryujinx/release-channel-master/releases/download/$tag_name/test-ava-ryujinx-$tag_name-win_x64.zip
          7z x test-ava-ryujinx-$tag_name-win_x64.zip
        shell: powershell
      
      - name: Compile .ISS to .EXE Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.1.0
        with:
          path: test-ava-ryujinx-win_x64-installer.iss
          options: /O+
      

      - name: Pushing new release
        uses: ncipollo/release-action@v1.11.1
        with:
          name: $tag_name
          artifacts: "build/*.exe"
          tag: $tag_name
          body: <h1 align="center">
                 <br>
                 <a href="https://github.com/LuccaWang404/Ryujinx-ava-installers"><img src="https://pic.imgdb.cn/item/64e25563661c6c8e54b74b17.png" alt="Ryujinx-ava-installers" width="150"></a>
                </h1>
                <h5 align="center">
                <b>龙神模拟器 [Avalonia UI 版] 安装程序发行版更新</b>
                </h5>
                <p align="center">
                  此发行包含目前龙神模拟器 [Avalonia UI 版] 的最新版安装程序和安装程序以 <a href ="https://jrsoftware.org/isinfo.php">Inno Setup</a> 脚本编写的源代码压缩存档。</br>
                  此项目为一个非官方的<a href="https://github.com/Ryujinx/Ryujinx">龙神任天堂Switch模拟器</a> [Avalonia UI 版] 安装程序构建版本。请前往官方代码仓库以了解更多细节。</br>
                  <b>由于本安装程序仍处于测试阶段，所有功能均不稳定并可能导致数据丢失，请谨慎使用！</b></br>
                  此项目通过GitHub Actions定时检查更新、即时构建，与官方渠道的发行进度基本同步。</br>
                  该项目源代码可在GitHub上以<a href="./LICENSE">MIT许可证</a>获取。</br>
                </p>
          omitBodyDuringUpdate: true
          allowUpdates: true
          replacesArtifacts: true
          owner: "LuccaWang404"
          repo: "Ryujinx-ava-installers"
          token: ${{ secrets.GITHUB_TOKEN }}
